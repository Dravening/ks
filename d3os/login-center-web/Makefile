# Identify the image that will be built and deployed.
IMAGE_ADDRESS ?= registry-edge.cosmoplat.com
IMAGE_PROJECT ?= kubesphere
# login-center-web
IMAGE_NAME ?= login-center-web
IMAGE_VERSION_LOGIN_CENTER_WEB ?= v0.0.1
IMAGE_LOGIN_CENTER_WEB ?= ${IMAGE_ADDRESS}/${IMAGE_PROJECT}/${IMAGE_NAME}

CHART_VERSION ?= 0.1.0
CHART_NAME ?= login-center-web

# helm create
create-chart:
	helm create ${CHART_NAME}

# modify chart information.
SED_REPO_LOGIN_CENTER_WEB ?= "s/repository:\ nginx/repository:\ ${IMAGE_ADDRESS}\/${IMAGE_PROJECT}\/${IMAGE_NAME}/g"
SED_TAG_LOGIN_CENTER_WEB ?= "s/tag: \"\"/tag: \"${IMAGE_VERSION_LOGIN_CENTER_WEB}\"/g"
SED_DESC_LOGIN_CENTER_WEB ?= "s/description: A Helm chart for Kubernetes/description: ${CHART_NAME}/g"
CONTAINER_PORT_LOGIN_CENTER_WEB ?= {{ .Values.service.port | default 80 }}
SED_CONTAINER_PORT_LOGIN_CENTER_WEB ?= "s/containerPort: 80/containerPort: ${CONTAINER_PORT_LOGIN_CENTER_WEB}/g"
# remove probes in deployment.yaml
SED_DELETE_PROBE :=
LIVENESS_PROBE ?= livenessProbe:
SED_DELETE_PROBE := /${LIVENESS_PROBE}/d
READINESS_PROBE ?= readinessProbe:
SED_DELETE_PROBE := ${SED_DELETE_PROBE};/${READINESS_PROBE}/d
PROBE_HTTP_GET ?= httpGet:
SED_DELETE_PROBE := ${SED_DELETE_PROBE};/${PROBE_HTTP_GET}/d
PROBE_PATH ?= path:\ \/
SED_DELETE_PROBE := ${SED_DELETE_PROBE};/${PROBE_PATH}/d
PROBE_PORT ?= port:\ http
SED_DELETE_PROBE := ${SED_DELETE_PROBE};/${PROBE_PORT}/d

sed-chart:
	sed -i '' ${SED_REPO_LOGIN_CENTER_WEB} ${CHART_NAME}/values.yaml
	sed -i '' ${SED_TAG_LOGIN_CENTER_WEB} ${CHART_NAME}/values.yaml
	sed -i '' ${SED_DESC_LOGIN_CENTER_WEB} ${CHART_NAME}/Chart.yaml
	sed -i '' ${SED_CONTAINER_PORT_LOGIN_CENTER_WEB} ${CHART_NAME}/templates/deployment.yaml
	sed -i '' "${SED_DELETE_PROBE}" ${CHART_NAME}/templates/deployment.yaml

# add env
ADD_DEPLOYMENT_ENV_BEFORE ?= imagePullPolicy:\ {{\ .Values.image.pullPolicy\ }}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_BEFORE}
ADD_DEPLOYMENT_WAP ?= \\n
ADD_DEPLOYMENT_SPACE ?= ' '
ADD_DEPLOYMENT_SPACE_10 ?= '          '
ADD_DEPLOYMENT_SPACE_12 ?= '            '
ADD_DEPLOYMENT_SPACE_14 ?= '              '
ADD_DEPLOYMENT_ENV_ENV ?= env:
ADD_DEPLOYMENT_ENV_NAME ?= -\ name:
ADD_DEPLOYMENT_ENV_VALUE ?= value:
# env name:
BACKEND_SERVICE_URL ?= BACKEND_SERVICE_URL

# env:
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_WAP}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE_10}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_ENV}
# backendServiceUrl
ADD_DEPLOYMENT_ENV_BACKEND_SERVICE_URL_NAME ?= ${BACKEND_SERVICE_URL}
ADD_DEPLOYMENT_ENV_BACKEND_SERVICE_URL_VALUE ?= {{\ .Values.env.${BACKEND_SERVICE_URL}\ }}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_WAP}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE_12}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_NAME}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_BACKEND_SERVICE_URL_NAME}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_WAP}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE_14}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_VALUE}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_SPACE}
ADD_DEPLOYMENT_ENV_AFTER := ${ADD_DEPLOYMENT_ENV_AFTER}${ADD_DEPLOYMENT_ENV_BACKEND_SERVICE_URL_VALUE}

# env in deployment
ADD_DEPLOYMENT_ENV ?= s/${ADD_DEPLOYMENT_ENV_BEFORE}/${ADD_DEPLOYMENT_ENV_AFTER}/g

ADD_VALUES_WAP ?= \\n
ADD_VALUES_SPACE ?= ' '
ADD_VALUES_SPACE_2 ?= '  '
ADD_VALUES_ENV_ENV ?= env:
ADD_VALUES_ENV_NAME_BACKEND_SERVICE_URL ?= ${BACKEND_SERVICE_URL}
ADD_VALUES_ENV := ''
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_WAP}
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_ENV_DESC}
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_ENV_ENV}
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_WAP}
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_SPACE_2}
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_ENV_NAME_BACKEND_SERVICE_URL}:
ADD_VALUES_ENV := ${ADD_VALUES_ENV}${ADD_VALUES_SPACE}

append-env:
	sed -i '' ${ADD_DEPLOYMENT_ENV} ${CHART_NAME}/templates/deployment.yaml
	echo ${ADD_VALUES_ENV} >> ${CHART_NAME}/values.yaml

# helm package
package-chart:
	helm package ${CHART_NAME}

chart: create-chart sed-chart append-env package-chart

# make clean: remove charts.
clean-chart:
	rm -rf ${CHART_NAME}

	rm ${CHART_NAME}*.tgz
clean-all: clean-chart
