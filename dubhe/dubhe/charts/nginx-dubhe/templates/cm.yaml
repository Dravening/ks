apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ template "nginx-dubhe.fullname" . }}
  labels:
    app: {{ template "nginx-dubhe.fullname" . }}
    chart: '{{ .Chart.Name }}-{{ .Chart.Version }}'
    release: '{{ .Release.Name }}'
    heritage: '{{ .Release.Service }}'
data:
  nginx.conf: |-
    #
    #For more information on configuration, see:
    #   * Official English Documentation: http://nginx.org/en/docs/
    #   * Official Russian Documentation: http://nginx.org/ru/docs/

    user nginx;
    worker_processes auto;
    error_log /var/log/nginx/error.log;
    pid /run/nginx.pid;

    # Load dynamic modules. See /usr/share/doc/nginx/README.dynamic.
    include /usr/share/nginx/modules/*.conf;

    events {
        worker_connections 1024;
    }

    http {
        log_format main '$remote_addr - $remote_user [$time_local] "$request" '
        '$status $body_bytes_sent "$http_referer" '
        '"$http_user_agent" "$http_x_forwarded_for"';

        access_log /var/log/nginx/access.log main;

        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        keepalive_timeout 65;
        types_hash_max_size 2048;

        client_max_body_size 8048M;
        proxy_request_buffering off;

        include /etc/nginx/mime.types;
        default_type application/octet-stream;

        # Load modular configuration files from the /etc/nginx/conf.d directory.
        # See http://nginx.org/en/docs/ngx_core_module.html#include
        # for more information.
        include /etc/nginx/conf.d/*.conf;


        map $http_upgrade $connection_upgrade {
            default upgrade;
            '' close;
        }

        server {

    		listen 80;
    		server_name *.api.dubhe.ai;
    		#	add_header Access-Control-Allow-Origin *;
    			add_header Access-Control-Allow-Methods *;
    			add_header Access-Control-Allow-Headers *;

    		proxy_set_header Host $host;
    			proxy_set_header X-real-ip $remote_addr;
    			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    		proxy_set_header X-Nginx-Proxy true;

    		location / {
    			proxy_pass  http://dubhe.{{ .Release.Namespace }}.svc:8081;
    		}
        }

        server {
            listen 8112;
            server_name _;

            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';
            add_header Access-Control-Allow-Headers 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization';

            location /api/v1/admin/ {
                proxy_set_header Host $host;
                proxy_set_header X-real-ip $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_pass http://dubhe.{{ .Release.Namespace }}.svc:8823/;
                client_max_body_size 100m;
            }
            location /api/v1/k8s/ {
                proxy_set_header Host $host;
                proxy_set_header X-real-ip $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_pass http://dubhe.{{ .Release.Namespace }}.svc:8823/;
                client_max_body_size 100m;
            }

            location /api/v1/notebook/ {
                proxy_set_header Host $host;
                proxy_set_header X-real-ip $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_pass http://dubhe.{{ .Release.Namespace }}.svc:8823/;
                client_max_body_size 100m;
            }
            location /api/v1/algorithm/ {
                proxy_set_header Host $host;
                proxy_set_header X-real-ip $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_pass http://dubhe.{{ .Release.Namespace }}.svc:8823/;
                client_max_body_size 100m;
            }
            location /api/v1/train/ {
                proxy_set_header Host $host;
                proxy_set_header X-real-ip $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_pass http://dubhe.{{ .Release.Namespace }}.svc:8823/;
                client_max_body_size 100m;
            }

            location /api/v1/image/ {
                proxy_set_header Host $host;
                proxy_set_header X-real-ip $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_pass http://dubhe.{{ .Release.Namespace }}.svc:8823/;
                client_max_body_size 100m;
            }
            location /api/v1/optimize/ {
                proxy_set_header Host $host;
                proxy_set_header X-real-ip $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_pass http://dubhe.{{ .Release.Namespace }}.svc:8823/;
                client_max_body_size 100m;
            }
            location /api/v1/tadl/ {
                proxy_set_header Host $host;
                proxy_set_header X-real-ip $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_pass http://dubhe.{{ .Release.Namespace }}.svc:8823/;
                client_max_body_size 100m;
            }
            location /api/v1/model/ {
                proxy_set_header Host $host;
                proxy_set_header X-real-ip $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_pass http://dubhe.{{ .Release.Namespace }}.svc:8823/;
                client_max_body_size 100m;
            }
            location /api/v1/measure/ {
                proxy_set_header Host $host;
                proxy_set_header X-real-ip $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_pass http://dubhe.{{ .Release.Namespace }}.svc:8823/;
                client_max_body_size 100m;
            }
    	    #云端部署服务
    	    location /api/v1/serving/ {
                proxy_set_header Host $host;
                proxy_set_header X-real-ip $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_pass http://dubhe.{{ .Release.Namespace }}.svc:8823/;
                client_max_body_size 100m;
            }
    	    location /api/v1/batchServing/ {
                proxy_set_header Host $host;
                proxy_set_header X-real-ip $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_pass http://dubhe.{{ .Release.Namespace }}.svc:8823/;
                client_max_body_size 100m;
            }
            #    location ~  .*\/api\/v1\/data\/.* {
            #       proxy_set_header  Host  $host;
            #       proxy_set_header  X-real-ip $remote_addr;
            #       proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
            #       proxy_pass   http://10.206.68.5:8823;
            #       client_max_body_size 100m;
            #   }
            location /api/v1/data/ {
                proxy_set_header Host $host;
                proxy_set_header X-real-ip $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_pass http://dubhe.{{ .Release.Namespace }}.svc:8823/;
                client_max_body_size 100m;
            }
            # 鉴权API
            location /auth/ {
                proxy_set_header Host $host;
                proxy_set_header X-real-ip $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_pass http://dubhe.{{ .Release.Namespace }}.svc:8823;
            }
            # 后端API
            #    location /api {
            #        proxy_set_header  Host  $host;
            #        proxy_set_header  X-real-ip $remote_addr;
            #        proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
            #        proxy_pass http://127.0.0.1:8200;   # 后端地址
            #    }
            # 可视化API
            # location /visual/api {
            #     proxy_pass http://127.0.0.1:8200;   # 后端地址
            # }
            # minIO 服务
            location /minio/ {
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-NginX-Proxy true;
                proxy_pass http://minio-dubhe.{{ .Release.Namespace }}.svc:9000; # minIO 服务地址
            }
            # minIO图片预览 注意去掉该虚拟路劲
            location /ImgMinio/ {
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-NginX-Proxy true;
                proxy_pass http://minio-dubhe.{{ .Release.Namespace }}.svc:9000/; # minIO 服务地址
            }
            # web前端创建minio时的路径 路径名是bucket 不能去掉
            location /dubhe-prod {
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-NginX-Proxy true;
                proxy_pass http://minio-dubhe.{{ .Release.Namespace }}.svc:9000; # minIO 服务地址
            }
            location ^~/dcm4chee/ {
                add_header Access-Control-Allow-Origin *;
                add_header Access-Control-Allow-Headers X-Requested-With,Content-Type;
                add_header Access-Control-Allow-Methods GET,POST,OPTIONS,PUT;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-NginX-Proxy true;
                proxy_pass http://dubhe.{{ .Release.Namespace }}.svc:8823/; # dcm服务地址 具体参数请根据部署数据处理算法文档中dcm服务部署后的具体地址来进行修改
            }
            location /ws {
                proxy_pass http://dubhe.{{ .Release.Namespace }}.svc:8823;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection $connection_upgrade;
            }

            location / {
                # root   /Dubhe/v4/webapp/dist; # dist 文件夹根目录
                root /Dubhe;
                index index.html;
                try_files $uri $uri/ /index.html;
                add_header Access-Control-Allow-Origin '*';
                add_header Access-Control-Allow-Headers '*';
                add_header Access-Control-Allow-Methods '*';
                add_header Access-Control-Allow-Credentials 'true';
            }
        }

        server {
            listen 9000;
            server_name localhost;
            #charset koi8-r;
            #access_log  logs/host.access.log  main;
            location / {
                proxy_set_header Host $host;
                proxy_pass http://minio-dubhe.{{ .Release.Namespace }}.svc:9000; # minIO 服务地址
            }
        }
    }

